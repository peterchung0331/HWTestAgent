<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HWTestAgent Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .status-item h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .status-item .value {
            font-size: 2em;
            font-weight: bold;
        }

        .endpoint {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .endpoint .method {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.85em;
            margin-right: 10px;
        }

        .method.get {
            background: #28a745;
            color: white;
        }

        .method.post {
            background: #007bff;
            color: white;
        }

        .endpoint code {
            background: #e9ecef;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        .test-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .result {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .result pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        /* Scenario Table Styles */
        .scenario-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .scenario-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
            font-size: 0.9em;
        }

        .scenario-table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
        }

        .scenario-table tr:hover {
            background: #f8f9fa;
        }

        .scenario-row {
            cursor: pointer;
            transition: background 0.2s;
        }

        .scenario-row.expanded {
            background: #f0f0f0;
        }

        .details-row {
            display: none;
            background: #fafafa;
        }

        .details-row.show {
            display: table-row;
        }

        .details-content {
            padding: 20px;
            border-left: 4px solid #667eea;
        }

        .step-item {
            background: white;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            border-left: 3px solid #28a745;
        }

        .step-item .step-number {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.85em;
            margin-right: 8px;
        }

        .env-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .env-production {
            background: #dc3545;
            color: white;
        }

        .env-staging {
            background: #ffc107;
            color: #333;
        }

        .env-development {
            background: #28a745;
            color: white;
        }

        .env-docker {
            background: #007bff;
            color: white;
        }

        .toggle-icon {
            margin-right: 8px;
            transition: transform 0.2s;
        }

        .toggle-icon.expanded {
            transform: rotate(90deg);
        }

        /* Tab Styles */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– HWTestAgent</h1>
            <p>24/7 AI-Powered Automated Testing System</p>
        </div>

        <div class="status-grid">
            <div class="status-item">
                <h3>ì„œë²„ ìƒíƒœ</h3>
                <div class="value" id="serverStatus">âœ…</div>
            </div>
            <div class="status-item">
                <h3>ë°ì´í„°ë² ì´ìŠ¤</h3>
                <div class="value" id="dbStatus">âœ…</div>
            </div>
            <div class="status-item">
                <h3>ì´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰</h3>
                <div class="value" id="totalRuns">0</div>
            </div>
            <div class="status-item">
                <h3>ì„±ê³µë¥ </h3>
                <div class="value" id="successRate">0%</div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“¡ API ì—”ë“œí¬ì¸íŠ¸</h2>

            <div class="endpoint">
                <span class="method get">GET</span>
                <code>/api/health</code>
                <p style="margin-top: 10px; color: #666;">ì„œë²„ ìƒíƒœ í™•ì¸</p>
            </div>

            <div class="endpoint">
                <span class="method post">POST</span>
                <code>/api/test/run</code>
                <p style="margin-top: 10px; color: #666;">í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ì¸ì¦ í•„ìš”)</p>
            </div>

            <div class="endpoint">
                <span class="method get">GET</span>
                <code>/api/test/results</code>
                <p style="margin-top: 10px; color: #666;">ìµœê·¼ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì¡°íšŒ</p>
            </div>

            <div class="endpoint">
                <span class="method get">GET</span>
                <code>/api/test/results/:id</code>
                <p style="margin-top: 10px; color: #666;">íŠ¹ì • í…ŒìŠ¤íŠ¸ ìƒì„¸ ê²°ê³¼</p>
            </div>

            <div class="endpoint">
                <span class="method get">GET</span>
                <code>/api/test/stats/:project</code>
                <p style="margin-top: 10px; color: #666;">í”„ë¡œì íŠ¸ í†µê³„</p>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“‹ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ëª©ë¡</h2>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('production')">ğŸ”´ Production</button>
                <button class="tab" onclick="switchTab('development')">ğŸŸ¢ Development</button>
                <button class="tab" onclick="switchTab('staging')">ğŸŸ¡ Staging</button>
                <button class="tab" onclick="switchTab('docker')">ğŸ”µ Docker(PRD)</button>
            </div>

            <div id="tab-production" class="tab-content active">
                <div id="scenarioList-production">
                    <div class="loading">ë¡œë”© ì¤‘...</div>
                </div>
            </div>

            <div id="tab-development" class="tab-content">
                <div id="scenarioList-development">
                    <div class="loading">ë¡œë”© ì¤‘...</div>
                </div>
            </div>

            <div id="tab-staging" class="tab-content">
                <div id="scenarioList-staging">
                    <div class="loading">ë¡œë”© ì¤‘...</div>
                </div>
            </div>

            <div id="tab-docker" class="tab-content">
                <div id="scenarioList-docker">
                    <div class="loading">ë¡œë”© ì¤‘...</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸš€ í…ŒìŠ¤íŠ¸ ì‹¤í–‰</h2>

            <div class="test-form">
                <div class="form-group">
                    <label>í”„ë¡œì íŠ¸</label>
                    <select id="project" onchange="updateScenarioOptions()">
                        <option value="">í”„ë¡œì íŠ¸ ì„ íƒ...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ì‹œë‚˜ë¦¬ì˜¤</label>
                    <select id="scenario">
                        <option value="">ë¨¼ì € í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>API Key</label>
                    <input type="password" id="apiKey" placeholder="hwtest_sk_live_..." />
                </div>

                <button class="btn" onclick="runTest()">í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
            </div>

            <div class="result" id="result">
                <h3>ê²°ê³¼:</h3>
                <pre id="resultContent"></pre>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“Š ìµœê·¼ í…ŒìŠ¤íŠ¸ ê²°ê³¼</h2>
            <div id="recentTests">
                <div class="loading">ë¡œë”© ì¤‘...</div>
            </div>
        </div>
    </div>

    <script>
        // Global scenarios data
        let allScenarios = [];

        // Load health status
        async function loadHealth() {
            try {
                const res = await fetch('/api/health');
                const data = await res.json();
                if (data.success) {
                    document.getElementById('serverStatus').textContent = 'âœ…';
                    document.getElementById('dbStatus').textContent = 'âœ…';
                }
            } catch (err) {
                document.getElementById('serverStatus').textContent = 'âŒ';
            }
        }

        // Get environment badge class
        function getEnvBadgeClass(env) {
            const envMap = {
                'production': 'env-production',
                'staging': 'env-staging',
                'development': 'env-development',
                'docker': 'env-docker'
            };
            return envMap[env] || 'env-development';
        }

        // Get environment display name
        function getEnvDisplayName(env) {
            const envMap = {
                'production': 'í”„ë¡œë•ì…˜',
                'staging': 'ìŠ¤í…Œì´ì§•',
                'development': 'ê°œë°œ',
                'docker': 'Docker(PRD)'
            };
            return envMap[env] || env;
        }

        // Toggle scenario details
        function toggleScenarioDetails(index) {
            const row = document.getElementById(`scenario-${index}`);
            const detailsRow = document.getElementById(`details-${index}`);
            const icon = document.getElementById(`icon-${index}`);

            if (detailsRow.classList.contains('show')) {
                detailsRow.classList.remove('show');
                row.classList.remove('expanded');
                icon.classList.remove('expanded');
            } else {
                detailsRow.classList.add('show');
                row.classList.add('expanded');
                icon.classList.add('expanded');
            }
        }

        // Switch tab function
        function switchTab(env) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tab-${env}`).classList.add('active');
        }

        // Render scenario table
        function renderScenarioTable(scenarios, containerId, startIndex = 0) {
            const container = document.getElementById(containerId);

            if (!scenarios || scenarios.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">ì´ í™˜ê²½ì—ëŠ” ì‹œë‚˜ë¦¬ì˜¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            // Build table
            let tableHTML = `
                <table class="scenario-table">
                    <thead>
                        <tr>
                            <th style="width: 120px;">í™˜ê²½</th>
                            <th style="width: 150px;">ëŒ€ìƒ í”„ë¡œì íŠ¸</th>
                            <th>í…ŒìŠ¤íŠ¸ ì œëª©</th>
                            <th style="width: 80px; text-align: center;">ìŠ¤í… ìˆ˜</th>
                            <th style="width: 150px;">ìŠ¤ì¼€ì¤„</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            scenarios.forEach((s, index) => {
                const globalIndex = startIndex + index;
                // Main row
                tableHTML += `
                    <tr id="scenario-${globalIndex}" class="scenario-row" onclick="toggleScenarioDetails(${globalIndex})">
                        <td>
                            <span class="env-badge ${getEnvBadgeClass(s.environment)}">
                                ${getEnvDisplayName(s.environment)}
                            </span>
                        </td>
                        <td><strong>${s.project}</strong></td>
                        <td>
                            <span id="icon-${globalIndex}" class="toggle-icon">â–¶</span>
                            ${s.name}
                            <br/>
                            <small style="color: #666;">${s.description || ''}</small>
                        </td>
                        <td style="text-align: center;"><strong>${s.stepCount}</strong></td>
                        <td><small>${s.schedule || 'Manual only'}</small></td>
                    </tr>
                `;

                // Details row
                tableHTML += `
                    <tr id="details-${globalIndex}" class="details-row">
                        <td colspan="5">
                            <div class="details-content">
                                <h4 style="color: #667eea; margin-bottom: 15px;">ğŸ“‹ ì„¸ë¶€ í…ŒìŠ¤íŠ¸ í•­ëª©</h4>
                                ${s.steps.map((step, stepIndex) => `
                                    <div class="step-item">
                                        <span class="step-number">Step ${stepIndex + 1}</span>
                                        <strong>${step.name}</strong>
                                        <br/>
                                        <small style="color: #666;">
                                            ${step.method || 'HTTP'} ${step.url || ''}
                                            ${step.timeout ? ` | Timeout: ${step.timeout}ms` : ''}
                                        </small>
                                    </div>
                                `).join('')}
                            </div>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }

        // Load scenarios
        async function loadScenarios() {
            try {
                const res = await fetch('/api/scenarios');
                const data = await res.json();

                if (data.success && data.data.length > 0) {
                    allScenarios = data.data;

                    // Group by environment
                    const production = data.data.filter(s => s.environment === 'production');
                    const development = data.data.filter(s => s.environment === 'development');
                    const staging = data.data.filter(s => s.environment === 'staging');
                    const docker = data.data.filter(s => s.environment === 'docker');

                    // Render each tab
                    renderScenarioTable(production, 'scenarioList-production', 0);
                    renderScenarioTable(development, 'scenarioList-development', production.length);
                    renderScenarioTable(staging, 'scenarioList-staging', production.length + development.length);
                    renderScenarioTable(docker, 'scenarioList-docker', production.length + development.length + staging.length);

                    // Populate project dropdown
                    const projects = [...new Set(data.data.map(s => s.project))];
                    const projectSelect = document.getElementById('project');
                    projectSelect.innerHTML = '<option value="">í”„ë¡œì íŠ¸ ì„ íƒ...</option>' +
                        projects.map(p => `<option value="${p}">${p}</option>`).join('');

                } else {
                    ['production', 'development', 'staging', 'docker'].forEach(env => {
                        document.getElementById(`scenarioList-${env}`).innerHTML = '<p style="color: #666;">ì‹œë‚˜ë¦¬ì˜¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    });
                }
            } catch (err) {
                console.error('Failed to load scenarios:', err);
                ['production', 'development', 'staging', 'docker'].forEach(env => {
                    document.getElementById(`scenarioList-${env}`).innerHTML = '<p style="color: #dc3545;">ì‹œë‚˜ë¦¬ì˜¤ ë¡œë“œ ì‹¤íŒ¨</p>';
                });
            }
        }

        // Update scenario dropdown based on selected project
        function updateScenarioOptions() {
            const project = document.getElementById('project').value;
            const scenarioSelect = document.getElementById('scenario');

            if (!project) {
                scenarioSelect.innerHTML = '<option value="">ë¨¼ì € í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
                return;
            }

            const projectScenarios = allScenarios.filter(s => s.project === project);

            if (projectScenarios.length === 0) {
                scenarioSelect.innerHTML = '<option value="">ì‹œë‚˜ë¦¬ì˜¤ ì—†ìŒ</option>';
                return;
            }

            scenarioSelect.innerHTML = projectScenarios.map(s =>
                `<option value="${s.slug}">${s.name}</option>`
            ).join('');
        }

        // Load recent tests
        async function loadRecentTests() {
            try {
                const res = await fetch('/api/test/results?limit=10');
                const data = await res.json();

                const container = document.getElementById('recentTests');

                if (data.success && data.data.length > 0) {
                    container.innerHTML = data.data.map(test => `
                        <div class="endpoint">
                            <strong>${test.project_name}</strong> - ${test.scenario_slug}
                            <br/>
                            <span style="color: ${test.status === 'PASSED' ? '#28a745' : '#dc3545'}">
                                ${test.status}
                            </span>
                            (${test.passed_steps}/${test.total_steps} passed)
                            <br/>
                            <small style="color: #666;">${new Date(test.created_at).toLocaleString()}</small>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p style="color: #666;">ì•„ì§ í…ŒìŠ¤íŠ¸ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
            } catch (err) {
                console.error('Failed to load tests:', err);
            }
        }

        // Run test
        async function runTest() {
            const project = document.getElementById('project').value;
            const scenario = document.getElementById('scenario').value;
            const apiKey = document.getElementById('apiKey').value;

            if (!apiKey) {
                alert('API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }

            const resultDiv = document.getElementById('result');
            const resultContent = document.getElementById('resultContent');

            resultDiv.style.display = 'block';
            resultContent.textContent = 'í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...';

            try {
                const res = await fetch('/api/test/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        project,
                        scenario,
                        environment: 'production',
                        auto_fix: true,
                        max_retry: 3
                    })
                });

                const data = await res.json();
                resultContent.textContent = JSON.stringify(data, null, 2);

                // Reload recent tests after 5 seconds
                setTimeout(loadRecentTests, 5000);
            } catch (err) {
                resultContent.textContent = 'Error: ' + err.message;
            }
        }

        // Load data on page load
        loadHealth();
        loadScenarios();
        loadRecentTests();

        // Refresh every 30 seconds
        setInterval(loadRecentTests, 30000);
    </script>
</body>
</html>
