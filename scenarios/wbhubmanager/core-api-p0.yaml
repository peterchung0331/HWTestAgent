# WBHubManager Core API P0 Test
# 시스템 장애 수준 Critical 기능 검증 - 인증, SSO, 핵심 데이터

name: "WBHubManager Core API P0 테스트"
slug: "core-api-p0"
description: "시스템 장애 수준 Critical 기능 검증 (11개 항목) - 인증, SSO, 핵심 데이터"
type: CORE_API_P0
priority: P0
environment: production
schedule: "0 */6 * * *"  # 6시간마다
timeout: 300000  # 5분
notify_on:
  - failure
  - recovery

variables:
  TARGET_URL: "https://wbhub.up.railway.app"
  SALESHUB_URL: "https://wbsaleshub.up.railway.app"
  FINHUB_URL: "https://wbfinhub.up.railway.app"
  TEST_EMAIL: "test-hwtest@wavebridge.kr"
  TEST_NAME: "HWTestAgent"

steps:
  # ===== 인증/보안 테스트 =====
  - name: "P0-AUTH-001: JWT Public Key 조회"
    type: http
    method: GET
    url: "{{TARGET_URL}}/api/auth/public-key"
    expect:
      status: 200
      json:
        publicKey: "@string"
        algorithm: "RS256"
    timeout: 10000

  - name: "P0-AUTH-002: Access Token 발급"
    type: http
    method: POST
    url: "{{TARGET_URL}}/api/auth/google-login"
    headers:
      Content-Type: "application/json"
    body:
      email: "{{TEST_EMAIL}}"
      name: "{{TEST_NAME}}"
    expect:
      status: 200
      json:
        accessToken: "@string"
        refreshToken: "@string"
    save:
      ACCESS_TOKEN: "response.body.accessToken"
      REFRESH_TOKEN: "response.body.refreshToken"
    timeout: 15000

  - name: "P0-AUTH-003: Access Token 검증"
    type: http
    method: POST
    url: "{{TARGET_URL}}/api/auth/verify"
    headers:
      Content-Type: "application/json"
    body:
      token: "{{ACCESS_TOKEN}}"
    expect:
      status: 200
      json:
        valid: true
    timeout: 10000

  - name: "P0-AUTH-004: Token 갱신"
    type: http
    method: POST
    url: "{{TARGET_URL}}/api/auth/refresh"
    headers:
      Content-Type: "application/json"
    body:
      refreshToken: "{{REFRESH_TOKEN}}"
    expect:
      status: 200
      json:
        accessToken: "@string"
    save:
      NEW_ACCESS_TOKEN: "response.body.accessToken"
    timeout: 15000

  # ===== 핵심 데이터 조회 =====
  - name: "P0-DATA-001: Hub 목록 조회"
    type: http
    method: GET
    url: "{{TARGET_URL}}/api/hubs"
    headers:
      Authorization: "Bearer {{NEW_ACCESS_TOKEN}}"
    expect:
      status: 200
      json:
        success: true
        data: "@array"
    timeout: 15000

  - name: "P0-DATA-002: Hub 상세 조회"
    type: http
    method: GET
    url: "{{TARGET_URL}}/api/hubs/wbsaleshub"
    headers:
      Authorization: "Bearer {{NEW_ACCESS_TOKEN}}"
    expect:
      status: 200
      json:
        success: true
    timeout: 10000

  # ===== SSO 통신 =====
  - name: "P0-SSO-001: SalesHub용 토큰 생성"
    type: http
    method: POST
    url: "{{TARGET_URL}}/api/auth/generate-hub-token"
    headers:
      Authorization: "Bearer {{NEW_ACCESS_TOKEN}}"
      Content-Type: "application/json"
    body:
      hub_slug: "wbsaleshub"
    expect:
      status: 200
      json:
        token: "@string"
    save:
      SSO_TOKEN: "response.body.token"
    timeout: 15000

  - name: "P0-SSO-002: SSO 토큰으로 SalesHub Health 확인"
    type: http
    method: GET
    url: "{{SALESHUB_URL}}/api/health"
    expect:
      status: 200
      json:
        success: true
    timeout: 10000

  # ===== 보안 테스트 =====
  - name: "P0-AUTH-005: 잘못된 토큰 거부"
    type: http
    method: GET
    url: "{{TARGET_URL}}/api/hubs"
    headers:
      Authorization: "Bearer invalid_token_12345"
    expect:
      status: 401
    timeout: 10000

  # ===== Logout 및 토큰 무효화 =====
  - name: "P0-AUTH-006: Logout (토큰 폐기)"
    type: http
    method: POST
    url: "{{TARGET_URL}}/api/auth/jwt-logout"
    headers:
      Content-Type: "application/json"
    body:
      refreshToken: "{{REFRESH_TOKEN}}"
    expect:
      status: 200
    timeout: 10000

  - name: "P0-AUTH-007: 폐기된 토큰 거부 확인"
    type: http
    method: POST
    url: "{{TARGET_URL}}/api/auth/verify"
    headers:
      Content-Type: "application/json"
    body:
      token: "{{ACCESS_TOKEN}}"
    expect:
      status: 401
    timeout: 10000
