# WBFinHub Precision Test
# Comprehensive verification after major changes

name: "WBFinHub 정밀 테스트"
slug: "precision"
description: "Railway 배포 전 포괄적 검증 테스트 (9개 항목)"
type: PRECISION
environment: production
schedule: "0 6,18 * * *"  # Twice daily: 6 AM and 6 PM
timeout: 300000  # 5 minutes
notify_on:
  - failure
  - recovery

variables:
  HUBMANAGER_URL: "https://wbhub.up.railway.app"
  FINHUB_URL: "https://wbfinhub.up.railway.app"
  TEST_EMAIL: "test-hwtest@wavebridge.kr"
  TEST_NAME: "HWTestAgent"

steps:
  # ============================================
  # Step 1: Health Check
  # ============================================
  - name: "Test 1: Health Check"
    type: http
    method: GET
    url: "{{FINHUB_URL}}/api/health"
    expect:
      status: 200
      json:
        success: true
    timeout: 10000

  # ============================================
  # Step 2: Database Connection - Accounts
  # ============================================
  - name: "Test 2: GET /api/accounts - 계정 목록 조회"
    type: http
    method: GET
    url: "{{FINHUB_URL}}/api/accounts"
    expect:
      status: 200
      json:
        success: true
        data: "@array"
    timeout: 15000

  # ============================================
  # Step 3: Transactions API
  # ============================================
  - name: "Test 3: GET /api/transactions - 거래 내역 조회"
    type: http
    method: GET
    url: "{{FINHUB_URL}}/api/transactions"
    expect:
      status: 200
      json:
        success: true
    timeout: 15000

  # ============================================
  # Step 4: Financial Reports
  # ============================================
  - name: "Test 4: GET /api/reports - 재무 보고서 조회"
    type: http
    method: GET
    url: "{{FINHUB_URL}}/api/reports"
    expect:
      status: 200
      json:
        success: true
    timeout: 15000

  # ============================================
  # Step 5: JWT Token from HubManager
  # ============================================
  - name: "Test 5: HubManager에서 JWT 토큰 발급"
    type: http
    method: POST
    url: "{{HUBMANAGER_URL}}/api/auth/google-login"
    headers:
      Content-Type: "application/json"
    body:
      email: "{{TEST_EMAIL}}"
      name: "{{TEST_NAME}}"
    expect:
      status: 200
      json:
        success: true
        data:
          accessToken: "@string"
    timeout: 15000
    save:
      JWT_TOKEN: "$.data.accessToken"

  # ============================================
  # Step 6: Access with JWT
  # ============================================
  - name: "Test 6: JWT로 FinHub 접근 (SSO)"
    type: http
    method: GET
    url: "{{FINHUB_URL}}/api/health"
    headers:
      Authorization: "Bearer {{JWT_TOKEN}}"
    expect:
      status: 200
      json:
        success: true
    timeout: 10000

  # ============================================
  # Step 7: Protected Route - Dashboard
  # ============================================
  - name: "Test 7: 보호된 라우트 - 재무 대시보드 접근"
    type: http
    method: GET
    url: "{{FINHUB_URL}}/api/dashboard"
    headers:
      Authorization: "Bearer {{JWT_TOKEN}}"
    expect:
      status: 200
      json:
        success: true
    timeout: 15000

  # ============================================
  # Step 8: Invalid Token Rejection
  # ============================================
  - name: "Test 8: 유효하지 않은 토큰 거부 확인"
    type: http
    method: GET
    url: "{{FINHUB_URL}}/api/dashboard"
    headers:
      Authorization: "Bearer invalid_token_12345"
    expect:
      status: 401
      json:
        success: false
    timeout: 10000

  # ============================================
  # Step 9: Frontend Access
  # ============================================
  - name: "Test 9: Frontend 접근 테스트"
    type: http
    method: GET
    url: "{{FINHUB_URL}}/"
    expect:
      status: 200
      headers:
        content-type: "@contains:text/html"
    timeout: 15000
