# WBSalesHub SSO Integration Test
# Tests SSO authentication flow with WBHubManager

name: "WBSalesHub SSO 통합 테스트"
slug: "sso-integration"
description: "WBHubManager와의 SSO 인증 흐름 검증"
type: SSO
environment: production
schedule: "0 */6 * * *"  # Every 6 hours
timeout: 300000  # 5 minutes
notify_on:
  - failure
  - recovery

variables:
  HUBMANAGER_URL: "https://wbhub.up.railway.app"
  SALESHUB_URL: "https://wbsaleshub.up.railway.app"
  TEST_EMAIL: "test-hwtest@wavebridge.kr"
  TEST_NAME: "HWTestAgent"

steps:
  # ============================================
  # Step 1: Get JWT Token from HubManager
  # ============================================
  - name: "Step 1: HubManager에서 JWT 토큰 발급"
    type: http
    method: POST
    url: "{{HUBMANAGER_URL}}/api/auth/google-login"
    headers:
      Content-Type: "application/json"
    body:
      email: "{{TEST_EMAIL}}"
      name: "{{TEST_NAME}}"
    expect:
      status: 200
      json:
        success: true
        data:
          accessToken: "@string"
          refreshToken: "@string"
    timeout: 15000
    save:
      JWT_TOKEN: "$.data.accessToken"
      REFRESH_TOKEN: "$.data.refreshToken"

  # ============================================
  # Step 2: Verify Token with HubManager
  # ============================================
  - name: "Step 2: HubManager에서 토큰 검증"
    type: http
    method: POST
    url: "{{HUBMANAGER_URL}}/api/auth/verify"
    headers:
      Content-Type: "application/json"
    body:
      token: "{{JWT_TOKEN}}"
    expect:
      status: 200
      json:
        success: true
        data:
          valid: true
    timeout: 10000

  # ============================================
  # Step 3: Access SalesHub with JWT
  # ============================================
  - name: "Step 3: JWT로 SalesHub 접근"
    type: http
    method: GET
    url: "{{SALESHUB_URL}}/api/health"
    headers:
      Authorization: "Bearer {{JWT_TOKEN}}"
    expect:
      status: 200
      json:
        success: true
    timeout: 10000

  # ============================================
  # Step 4: SalesHub - Get Customers (Protected Route)
  # ============================================
  - name: "Step 4: SalesHub - 고객 목록 조회 (인증 필요)"
    type: http
    method: GET
    url: "{{SALESHUB_URL}}/api/customers"
    headers:
      Authorization: "Bearer {{JWT_TOKEN}}"
    expect:
      status: 200
      json:
        success: true
        data: "@array"
    timeout: 15000

  # ============================================
  # Step 5: Invalid Token - Should Reject
  # ============================================
  - name: "Step 5: 유효하지 않은 토큰 거부 확인"
    type: http
    method: GET
    url: "{{SALESHUB_URL}}/api/customers"
    headers:
      Authorization: "Bearer invalid_token_12345"
    expect:
      status: 401
      json:
        success: false
    timeout: 10000

  # ============================================
  # Step 6: Logout from HubManager
  # ============================================
  - name: "Step 6: HubManager에서 로그아웃"
    type: http
    method: POST
    url: "{{HUBMANAGER_URL}}/api/auth/jwt-logout"
    headers:
      Content-Type: "application/json"
    body:
      refreshToken: "{{REFRESH_TOKEN}}"
    expect:
      status: 200
      json:
        success: true
    timeout: 10000

  # ============================================
  # Step 7: Token Should Be Invalid After Logout
  # ============================================
  - name: "Step 7: 로그아웃 후 토큰 무효화 확인"
    type: http
    method: GET
    url: "{{SALESHUB_URL}}/api/customers"
    headers:
      Authorization: "Bearer {{JWT_TOKEN}}"
    expect:
      status: 401
      json:
        success: false
    timeout: 10000
