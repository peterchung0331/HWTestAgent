# WBFinHub Core API P1 Test
# 핵심 기능 오류 수준 High 기능 검증 - Account CRUD, 관계 데이터, 권한

name: "WBFinHub Core API P1 테스트"
slug: "core-api-p1"
description: "핵심 기능 검증 (14개 항목) - Account CRUD, Transaction, 권한, 데이터 무결성"
type: CORE_API_P1
priority: P1
environment: production
schedule: "0 8,20 * * *"  # 하루 2회 (8시, 20시)
timeout: 300000  # 5분
notify_on:
  - failure
  - recovery

variables:
  TARGET_URL: "https://wbfinhub.up.railway.app"
  HUBMANAGER_URL: "https://wbhub.up.railway.app"
  TEST_EMAIL: "test-hwtest@wavebridge.kr"
  TEST_NAME: "HWTestAgent"
  TEST_ACCOUNT_NAME: "P1 테스트 계좌"
  TEST_ACCOUNT_NUMBER: "P1-TEST-001"

steps:
  # ===== 인증 토큰 발급 =====
  - name: "Setup: HubManager 토큰 발급"
    type: http
    method: POST
    url: "{{HUBMANAGER_URL}}/api/auth/google-login"
    headers:
      Content-Type: "application/json"
    body:
      email: "{{TEST_EMAIL}}"
      name: "{{TEST_NAME}}"
    expect:
      status: 200
    save:
      ACCESS_TOKEN: "response.body.accessToken"
    timeout: 15000

  # ===== CRUD 테스트 =====
  - name: "P1-CRUD-001: Account 생성"
    type: http
    method: POST
    url: "{{TARGET_URL}}/api/accounts"
    headers:
      Authorization: "Bearer {{ACCESS_TOKEN}}"
      Content-Type: "application/json"
    body:
      name: "{{TEST_ACCOUNT_NAME}}"
      accountNumber: "{{TEST_ACCOUNT_NUMBER}}"
      accountType: "savings"
      currency: "KRW"
      balance: 0
      status: "active"
    expect:
      status: 201
      json:
        success: true
    save:
      ACCOUNT_ID: "response.body.data.id"
    timeout: 15000

  - name: "P1-CRUD-002: 생성된 Account 조회"
    type: http
    method: GET
    url: "{{TARGET_URL}}/api/accounts/{{ACCOUNT_ID}}"
    headers:
      Authorization: "Bearer {{ACCESS_TOKEN}}"
    expect:
      status: 200
      json:
        success: true
    timeout: 10000

  - name: "P1-CRUD-003: Account 수정"
    type: http
    method: PUT
    url: "{{TARGET_URL}}/api/accounts/{{ACCOUNT_ID}}"
    headers:
      Authorization: "Bearer {{ACCESS_TOKEN}}"
      Content-Type: "application/json"
    body:
      name: "{{TEST_ACCOUNT_NAME}} - 수정됨"
      status: "inactive"
    expect:
      status: 200
      json:
        success: true
    timeout: 15000

  - name: "P1-CRUD-004: 수정된 Account 확인"
    type: http
    method: GET
    url: "{{TARGET_URL}}/api/accounts/{{ACCOUNT_ID}}"
    headers:
      Authorization: "Bearer {{ACCESS_TOKEN}}"
    expect:
      status: 200
      json:
        success: true
    timeout: 10000

  # ===== 관계 데이터 테스트 =====
  - name: "P1-REL-001: Account의 Transaction 목록 조회"
    type: http
    method: GET
    url: "{{TARGET_URL}}/api/accounts/{{ACCOUNT_ID}}/transactions"
    headers:
      Authorization: "Bearer {{ACCESS_TOKEN}}"
    expect:
      status: 200
      json:
        success: true
    timeout: 10000

  - name: "P1-REL-002: Account에 Transaction 생성"
    type: http
    method: POST
    url: "{{TARGET_URL}}/api/accounts/{{ACCOUNT_ID}}/transactions"
    headers:
      Authorization: "Bearer {{ACCESS_TOKEN}}"
      Content-Type: "application/json"
    body:
      type: "deposit"
      amount: 10000
      description: "P1 테스트 입금"
      currency: "KRW"
    expect:
      status: 201
    save:
      TRANSACTION_ID: "response.body.data.id"
    timeout: 15000

  # ===== 권한 검증 테스트 =====
  - name: "P1-AUTH-001: 인증 없이 Account 조회 시도"
    type: http
    method: GET
    url: "{{TARGET_URL}}/api/accounts"
    expect:
      status: 401
    timeout: 10000

  - name: "P1-AUTH-002: 인증 없이 Account 생성 시도"
    type: http
    method: POST
    url: "{{TARGET_URL}}/api/accounts"
    headers:
      Content-Type: "application/json"
    body:
      name: "Unauthorized Account"
    expect:
      status: 401
    timeout: 10000

  # ===== 데이터 무결성 테스트 =====
  - name: "P1-VAL-001: 필수 필드 누락 (이름 없음)"
    type: http
    method: POST
    url: "{{TARGET_URL}}/api/accounts"
    headers:
      Authorization: "Bearer {{ACCESS_TOKEN}}"
      Content-Type: "application/json"
    body:
      accountNumber: "VAL-001"
    expect:
      status: 400
    timeout: 10000

  - name: "P1-VAL-002: 잘못된 계좌 유형"
    type: http
    method: POST
    url: "{{TARGET_URL}}/api/accounts"
    headers:
      Authorization: "Bearer {{ACCESS_TOKEN}}"
      Content-Type: "application/json"
    body:
      name: "Invalid Type Test"
      accountType: "invalid_type"
    expect:
      status: 400
    timeout: 10000

  # ===== 정리: 테스트 데이터 삭제 =====
  - name: "Cleanup: Transaction 삭제"
    type: http
    method: DELETE
    url: "{{TARGET_URL}}/api/transactions/{{TRANSACTION_ID}}"
    headers:
      Authorization: "Bearer {{ACCESS_TOKEN}}"
    expect:
      status: 200
    timeout: 10000

  - name: "P1-CRUD-005: Account 삭제"
    type: http
    method: DELETE
    url: "{{TARGET_URL}}/api/accounts/{{ACCOUNT_ID}}"
    headers:
      Authorization: "Bearer {{ACCESS_TOKEN}}"
    expect:
      status: 200
    timeout: 10000

  - name: "P1-CRUD-006: 삭제된 Account 조회 (404 확인)"
    type: http
    method: GET
    url: "{{TARGET_URL}}/api/accounts/{{ACCOUNT_ID}}"
    headers:
      Authorization: "Bearer {{ACCESS_TOKEN}}"
    expect:
      status: 404
    timeout: 10000
