# WBFinHub Core API P0 Test
# 시스템 장애 수준 Critical 기능 검증 - SSO 인증, 핵심 데이터

name: "WBFinHub Core API P0 테스트"
slug: "core-api-p0-docker"
description: "시스템 장애 수준 Critical 기능 검증 (9개 항목) - SSO 인증, 핵심 데이터"
type: CORE_API_P0
priority: P0
environment: docker
# schedule disabled for docker
timeout: 300000  # 5분
notify_on:
  - failure
  - recovery

variables:
  TARGET_URL: "http://158.180.95.246:3092"
  HUBMANAGER_URL: "http://158.180.95.246:3090"
  TEST_EMAIL: "test-hwtest@wavebridge.kr"
  TEST_NAME: "HWTestAgent"

steps:
  # ===== HubManager에서 토큰 발급 =====
  - name: "P0-AUTH-001: HubManager Public Key 조회"
    type: http
    method: GET
    url: "{{HUBMANAGER_URL}}/api/auth/public-key"
    expect:
      status: 200
      json:
        publicKey: "@string"
        algorithm: "RS256"
    timeout: 10000

  - name: "P0-AUTH-002: HubManager 토큰 발급"
    type: http
    method: POST
    url: "{{HUBMANAGER_URL}}/api/auth/google-login"
    headers:
      Content-Type: "application/json"
    body:
      email: "{{TEST_EMAIL}}"
      name: "{{TEST_NAME}}"
    expect:
      status: 200
    save:
      ACCESS_TOKEN: "response.body.accessToken"
      REFRESH_TOKEN: "response.body.refreshToken"
    timeout: 15000

  - name: "P0-AUTH-003: 토큰 검증"
    type: http
    method: POST
    url: "{{HUBMANAGER_URL}}/api/auth/verify"
    headers:
      Content-Type: "application/json"
    body:
      token: "{{ACCESS_TOKEN}}"
    expect:
      status: 200
      json:
        valid: true
    timeout: 10000

  # ===== SSO 인증 접근 =====
  - name: "P0-SSO-001: SSO 토큰으로 Health API 접근"
    type: http
    method: GET
    url: "{{TARGET_URL}}/api/health"
    headers:
      Authorization: "Bearer {{ACCESS_TOKEN}}"
    expect:
      status: 200
    timeout: 10000

  # ===== 핵심 데이터 조회 =====
  - name: "P0-DATA-001: Account 목록 조회"
    type: http
    method: GET
    url: "{{TARGET_URL}}/api/accounts"
    headers:
      Authorization: "Bearer {{ACCESS_TOKEN}}"
    expect:
      status: 200
      json:
        success: true
    timeout: 15000

  - name: "P0-DATA-002: Transaction 목록 조회"
    type: http
    method: GET
    url: "{{TARGET_URL}}/api/transactions"
    headers:
      Authorization: "Bearer {{ACCESS_TOKEN}}"
    expect:
      status: 200
      json:
        success: true
    timeout: 15000

  # ===== 보안 테스트 =====
  - name: "P0-AUTH-004: 잘못된 토큰 거부"
    type: http
    method: GET
    url: "{{TARGET_URL}}/api/accounts"
    headers:
      Authorization: "Bearer invalid_token"
    expect:
      status: 401
    timeout: 10000

  # ===== Logout 후 접근 차단 =====
  - name: "P0-AUTH-005: HubManager Logout"
    type: http
    method: POST
    url: "{{HUBMANAGER_URL}}/api/auth/jwt-logout"
    headers:
      Content-Type: "application/json"
    body:
      refreshToken: "{{REFRESH_TOKEN}}"
    expect:
      status: 200
    timeout: 10000

  - name: "P0-SSO-002: 로그아웃 후 접근 차단 확인"
    type: http
    method: GET
    url: "{{TARGET_URL}}/api/accounts"
    headers:
      Authorization: "Bearer {{ACCESS_TOKEN}}"
    expect:
      status: 401
    timeout: 10000
